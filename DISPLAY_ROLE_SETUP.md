# 投屏角色 (Display Role) 设置指南

## 概述

投屏角色是一个新的用户角色，专门用于在大屏幕上展示游戏的实时状态。投屏用户可以访问 `/show` 路由，该页面实时显示：

- 当前游戏状态（等待、进行中、结束）
- 当前题目和选项
- 实时倒计时
- 轮次结果
- 存活和淘汰玩家统计

## 设置投屏用户

### 1. 运行管理脚本

在后端目录中运行以下命令：

```bash
cd backend
npm run manage-display
```

### 2. 添加投屏用户邮箱

在管理脚本中选择选项 1，然后输入要设置为投屏用户的 Gmail 邮箱地址。

### 3. 验证设置

- 选择选项 3 可以查看当前所有的投屏用户
- 使用投屏用户邮箱登录系统
- 系统会自动重定向到 `/show` 页面

## 用户角色说明

现在系统支持三种用户角色：

1. **普通用户** - 参与游戏，访问 `/play` 页面
2. **投屏用户** - 展示游戏状态，访问 `/show` 页面  
3. **管理员** - 控制游戏流程，访问 `/admin` 页面

## 路由保护

- `/show` 路由受中间件保护，只有投屏用户可以访问
- 普通用户尝试访问 `/show` 会被重定向到 `/play`
- 投屏用户尝试访问 `/play` 会被重定向到 `/show`
- 管理员尝试访问 `/play` 或 `/show` 会被重定向到 `/admin`

## 实时更新

投屏页面通过 WebSocket 连接实时接收游戏状态更新：

- 新题目发布
- 轮次结果
- 游戏状态变化
- 倒计时更新

## 故障排除

### 1. 无法访问投屏页面

检查邮箱是否已添加到投屏用户列表：

```bash
cd backend
npm run manage-display
# 选择选项 3 查看投屏用户列表
```

### 2. 页面无法连接到游戏服务器

检查 WebSocket 连接配置：

- 确保 `NEXT_PUBLIC_WS_URL` 环境变量设置正确
- 确保后端 WebSocket 服务正在运行

### 3. 页面显示错误数据

检查类型定义和数据结构是否匹配前端预期格式。

## 技术细节

### 数据库存储

投屏用户邮箱存储在 Redis 集合中：
- Key: `nextauth:display_emails`
- Type: SET
- Value: 邮箱地址列表

### 认证流程

1. 用户通过 Google OAuth 登录
2. JWT 回调检查用户邮箱是否在投屏用户列表中
3. 在 token 中设置 `isDisplay` 标志
4. 中间件根据角色进行路由保护和重定向

### WebSocket 消息

投屏页面监听以下消息类型：
- `game_state` - 游戏状态更新
- `new_question` - 新题目发布
- `round_result` - 轮次结果
- `game_ended` - 游戏结束
